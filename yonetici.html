<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aile Aƒüacƒ± V144 (Akƒ±llƒ± Navigasyon)</title>
    <style>
        /* --- TEMEL AYARLAR --- */
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        #tabs-container { background: #dfe6e9; padding: 5px 10px 0; display: flex; gap: 5px; height: 40px; align-items: flex-end; border-bottom: 1px solid #ccc; flex-shrink: 0; z-index: 1900; overflow-x: auto; }
        .tab { background: #b2bec3; color: white; padding: 8px 15px; border-radius: 8px 8px 0 0; font-size: 13px; font-weight: bold; cursor: pointer; border: 1px solid #95a5a6; border-bottom: none; min-width: 80px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px; white-space: nowrap; }
        .tab.active { background: #fff; color: #2c3e50; border-top: 3px solid #3498db; position: relative; top: 1px; z-index: 10; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
        .tab-close { font-size: 14px; width: 18px; height: 18px; line-height: 16px; border-radius: 50%; background: rgba(0,0,0,0.2); color: white; display: inline-flex; align-items: center; justify-content: center; }
        .tab.home .tab-close { display: none; }
        
        #toolbar { background: #2c3e50; padding: 10px; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 2000; display: flex; align-items: center; justify-content: space-between; gap: 10px; overflow-x: auto; white-space: nowrap; height: 50px; flex-shrink: 0; }
        
        button, .btn-upload { cursor: pointer; padding: 8px 12px; border: none; border-radius: 4px; font-weight: bold; color: white; display: inline-flex; align-items: center; gap:5px; font-size: 12px; height: 32px; flex-shrink: 0; }
        .btn-blue { background: #2980b9; } .btn-red { background: #c0392b; } .btn-green { background: #27ae60; } 
        .btn-purple { background: #8e44ad; } .btn-pink { background: #e84393; } .btn-orange { background: #d35400; } 
        .btn-dark { background: #34495e; } .btn-cyan { background: #00bcd4; color: white; }
        .btn-gold { background: #f1c40f; color: #2c3e50; border: 2px solid #f39c12; }
        .btn-upload { background: #2980b9; margin: 0;} input[type="file"] { display: none; }
        
        #msg-input { padding: 5px; border-radius: 4px; border: none; margin-left: 10px; width: 180px; font-size: 12px; color: #333; }
        #site-msg-display { position: fixed; top: 60px; left: 20px; background: rgba(255, 255, 255, 0.98); padding: 15px 25px 15px 15px; border-left: 5px solid #2980b9; border-radius: 4px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 1800; font-weight: 500; color: #333; display: none; max-width: 350px; font-size: 13px; line-height: 1.4; pointer-events: auto; }
        .msg-close-btn { position: absolute; top: 2px; right: 5px; background: none; border: none; color: #999; font-size: 16px; font-weight: bold; cursor: pointer; padding: 0 5px; }
        .msg-close-btn:hover { color: #c0392b; }
        #msg-reopen-btn { position: fixed; top: 60px; left: 10px; background: #3498db; color: white; padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1799; cursor: pointer; display: none; border: 2px solid white; }
        
        #viewport { flex: 1; overflow: hidden; position: relative; background: radial-gradient(#ccc 1px, transparent 1px); background-size: 20px 20px; cursor: default; touch-action: none; }
        #world { position: absolute; top: 0; left: 0; transform-origin: 0 0; transition: transform 0.1s linear; width: 100%; display: flex; justify-content: center; }
        
        /* --- AƒûA√á Sƒ∞STEMƒ∞ (√áƒ∞ZGƒ∞ D√úZELTMELERƒ∞) --- */
        .tree ul { padding-top: 25px; position: relative; display: flex; justify-content: center; pointer-events: none; }
        .tree li { float: left; text-align: center; list-style-type: none; position: relative; padding: 20px 5px 0 5px; pointer-events: none; --stem-pos: 50%; }
        
        /* √áOCUƒûUN YUKARI Gƒ∞DEN √áƒ∞ZGƒ∞Sƒ∞ */
        .tree li::before { 
            content: ''; position: absolute; top: 0; height: 20px; z-index: -1; pointer-events: none;
            right: calc(100% - var(--stem-pos)); 
            width: var(--stem-pos); 
            border-top: 2px solid #aaa; 
        }
        
        .tree li::after { 
            content: ''; position: absolute; top: 0; height: 20px; z-index: -1; pointer-events: none;
            left: var(--stem-pos); 
            width: calc(100% - var(--stem-pos)); 
            border-left: 2px solid #aaa; 
            border-top: 2px solid #aaa;
            right: auto;
        }

        /* ƒ∞lk ve Son √áocuk D√ºzeltmeleri */
        .tree li:only-child::after, .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        
        .tree li:first-child::before { border: 0 none; }
        /* ƒ∞lk √ßocuƒüun saƒüa giden √ßizgisi */
        .tree li:first-child::after { border-radius: 0; }
        
        /* Son √ßocuƒüun sola giden √ßizgisi */
        .tree li:last-child::before { border-right: none; border-radius: 0; }
        .tree li:last-child::after { border: none; border-left: 2px solid #aaa; } /* Sadece dikey sap kalmalƒ± */
        
        /* PARENT'TAN A≈ûAƒûI ƒ∞NEN √áƒ∞ZGƒ∞ */
        .tree ul ul::before { 
            content: ''; 
            position: absolute; 
            top: 0; 
            left: var(--stem-pos);
            border-left: 2px solid #aaa; 
            width: 0; 
            height: 20px; 
            z-index: -1; 
            pointer-events: none; 
        }

        /* √úVEY (NOKTALI) */
        .tree li.to-dotted > ul::before { border-left-style: dotted !important; border-width: 3px !important; }
        .tree li.to-dotted::before, .tree li.to-dotted::after { border-style: dotted !important; border-width: 3px !important; }
        
        /* E≈ûLER ARASI BO≈ûLUK */
        .couple-wrapper { display: inline-flex; gap: 45px; align-items: flex-start; position: relative; padding: 10px; pointer-events: none; }
        .couple-wrapper.has-spouse::before { content: ''; position: absolute; top: 60px; left: 50%; transform: translateX(-50%); width: 40px; height: 2px; background: #999; z-index: -1; pointer-events: none; }
        .couple-wrapper.line-red::before { background: none !important; border-top: 2px dashed #e74c3c !important; height: 0; }
        .couple-wrapper.line-dashed::before { background: none; border-top: 2px dashed #777; height: 0; }

        /* KART TASARIMI */
        .card { 
            background: white; border: 1px solid #ccc; border-radius: 8px; position: relative; z-index: 100; cursor: pointer; display: flex; flex-direction: column; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); pointer-events: auto !important; user-select: none;
            width: 140px !important; min-width: 140px !important; max-width: 140px !important;
            height: 170px !important; min-height: 170px !important; max-height: 170px !important;
            padding: 10px 5px; box-sizing: border-box; overflow: visible; 
        }
        .card.male { background: #f0f8ff; border-color: #4682b4; } .card.female { background: #fff0f5; border-color: #ff69b4; }
        .card.selected { border: 4px solid #2ecc71 !important; transform: scale(1.05); z-index: 110; box-shadow: 0 0 15px rgba(46, 204, 113, 0.5); }
        .card.deceased { background: #f0f0f0 !important; border-color: #777 !important; filter: grayscale(1); }
        .card.moving-source { border: 3px dashed #e67e22 !important; background: #fff3e0 !important; opacity:0.8; }
        
        /* ƒ∞KONLAR */
        .icon-btn { position: absolute; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer; z-index: 200; }
        .inspect-btn { top: -14px; left: -14px; background: #34495e; color: white; }
        .portal-indicator { top: -14px; right: -14px; background: #27ae60; color: white; display: none; }
        .portal-indicator::after { content: 'üå≥'; } .portal-indicator:hover { transform: scale(1.1); background: #2ecc71; } .card.has-portal .portal-indicator { display: flex; }
        .ribbon { position: absolute; top: -5px; right: -5px; font-size: 20px; display: none; z-index: 150; } 
        .card.deceased .ribbon { display: block; } 
        .card.has-portal.deceased .ribbon { top: 22px !important; right: -8px !important; } 
        
        .photo { width: 60px; height: 60px; background: rgba(255,255,255,0.5); border-radius: 50%; overflow: hidden; margin-bottom: 5px; border: 2px solid rgba(0,0,0,0.1); box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center; pointer-events: auto; cursor: zoom-in; flex-shrink: 0; transition: transform 0.2s; }
        .photo:hover { transform: scale(1.1); border-color: #3498db; } .photo img { width: 100%; height: 100%; object-fit: cover; }
        .name, .surname, .title, .info-row { width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; display: block; }
        .name { font-weight: 800; font-size: 13px; color: #2d3436; margin-bottom: 2px; } .surname { font-weight: 700; font-size: 11px; color: #2d3436; text-transform: uppercase; margin-bottom: 3px; }
        .title { font-size: 10px; color: #555; font-weight: 600; margin-bottom: 2px; } .info-row { font-size: 9px; color: #666; padding: 1px 0; }
        .note-preview { font-size: 9px; color: #888; background: rgba(255,255,255,0.5); padding: 2px; border-radius: 4px; margin-top: 2px; width: 90%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        @media only screen and (max-width: 768px) {
            .card { width: 110px !important; min-width: 110px !important; max-width: 110px !important; height: 140px !important; min-height: 140px !important; max-height: 140px !important; padding: 8px 2px; }
            .photo { width: 45px; height: 45px; margin-bottom: 2px; }
            .name { font-size: 10px; margin-bottom: 1px; } .surname { font-size: 9px; margin-bottom: 1px; }
            .title { font-size: 8px; margin-bottom: 1px; } .info-row { font-size: 8px; }
            .note-preview { display: none; }
            .icon-btn { width: 24px; height: 24px; font-size: 12px; }
            .inspect-btn { top: -10px; left: -10px; }
            .portal-indicator { top: -10px; right: -10px; }
            .card.has-portal.deceased .ribbon { top: 15px !important; }
            .couple-wrapper { gap: 30px; }
            .tree li.to-father { --axis-pos: 22%; }
            .tree li.to-mother { --axis-pos: 78%; }
            .couple-wrapper.has-spouse::before { top: 40px; width: 25px; }
            #toolbar { height: 45px; gap: 3px; padding: 5px; }
            #toolbar button, .btn-upload { padding: 5px 8px; font-size: 10px; height: 28px; }
            #msg-input { width: 100px; font-size: 10px; height: 20px; }
            #site-msg-display { top: 55px; left: 5%; width: 90%; max-width: none; font-size: 11px; padding: 10px 20px 10px 10px; box-sizing: border-box; }
            #msg-reopen-btn { top: 55px; left: 10px; padding: 6px 10px; font-size: 10px; }
        }

        #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:6000; justify-content:center; align-items:center; backdrop-filter: blur(2px); }
        .modal-box { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 350px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
        .input-row { margin-bottom: 12px; } .input-row label { display: block; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 4px; }
        .input-row input, .input-row textarea, .input-row select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-family: inherit; font-size: 16px; }
        .checkbox-container { display: flex; align-items: center; gap: 10px; background: #fff0f0; border: 1px solid #ffcccc; padding: 12px; border-radius: 8px; cursor: pointer; }
        .checkbox-container input { width: 20px; height: 20px; } .checkbox-container label { margin: 0; color: #c0392b; font-weight: bold; }
        .photo-gallery { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .mini-photo-wrapper { position: relative; } .mini-photo { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #ccc; }
        .delete-mini { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1px solid white; }
        
        #bottom-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 10px; display: flex; align-items: center; justify-content: space-between; z-index: 4900; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); box-sizing: border-box; }
        #zoom-range { flex: 1; margin: 0 15px; cursor: pointer; }
        #hand-mode-box { background: #f1c40f; padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px; font-weight: bold; font-size: 13px; cursor: pointer; border: 2px solid #f39c12; }
        #hand-mode-box input { width: 18px; height: 18px; cursor: pointer; }
        .btn-focus { background: #e67e22; border: 2px solid #d35400; padding: 8px 12px; border-radius: 8px; color: white; font-weight: bold; font-size: 13px; cursor: pointer; margin-right: 10px; flex-shrink: 0;}
        
        /* FOTOƒûRAF G√ñR√úNT√úLEYƒ∞Cƒ∞ */
        #insta-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 7000; justify-content: center; align-items: center; backdrop-filter: blur(5px); touch-action: none; }
        #insta-card { background: white; width: 90%; max-width: 380px; border-radius: 20px; overflow: hidden; position: relative; animation: pop 0.3s; transition: all 0.3s ease; }
        #insta-img-area { height: 350px; background: #222; display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden; touch-action: none; transition: height 0.3s ease; }
        #insta-img-area img { max-width: 100%; max-height: 100%; object-fit: contain; transform-origin: center; transition: transform 0.1s ease-out; }
        .slide-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.3); color: white; border: none; padding: 10px; cursor: pointer; font-size: 20px; border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; z-index: 10; }
        .prev-btn { left: 10px; } .next-btn { right: 10px; }
        #insta-dots { position: absolute; bottom: 10px; display: flex; gap: 5px; z-index: 10; } .dot { width: 8px; height: 8px; background: rgba(255,255,255,0.5); border-radius: 50%; } .dot.active { background: white; }
        #insta-info { padding: 20px; max-height: 35vh; overflow-y: auto; transition: opacity 0.3s ease; }
        .info-block { margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .info-label { font-size: 10px; font-weight: bold; color: #888; text-transform: uppercase; } .info-val { font-size: 15px; color: #222; font-weight: 600; }
        .close-insta { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.5); color: white; width: 35px; height: 35px; border-radius: 50%; border: none; font-size: 18px; cursor: pointer; z-index: 20; }
        
        #insta-card.is-fullscreen { width: 100%; height: 100%; max-width: none; border-radius: 0; }
        #insta-card.is-fullscreen #insta-info { display: none; }
        #insta-card.is-fullscreen #insta-img-area { height: 100%; background: black; }
        #fullscreen-hint { position: absolute; bottom: 20px; left: 0; width: 100%; text-align: center; color: rgba(255,255,255,0.7); font-size: 11px; pointer-events: none; z-index: 15; text-shadow: 0 1px 2px black; animation: fadeOut 4s forwards; }
        @keyframes fadeOut { 0% {opacity: 1;} 80% {opacity: 1;} 100% {opacity: 0;} }

        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; color: white; flex-direction: column; justify-content: center; align-items: center; text-align: center; font-size: 20px; }
    </style>
</head>
<body>
<div id="tabs-container"></div>
<div id="toolbar">
    <div style="display:flex; gap:8px; align-items:center;">
        <label for="up" class="btn-upload">üìÇ Y√ºkle</label> <input type="file" id="up" onchange="uploadData(this)">
        <button class="btn-blue" onclick="downloadData()">üíæ Kaydet</button>
        <button class="btn-gold" onclick="generateShareFile()">üì§ Sƒ∞TEYƒ∞ ƒ∞NDƒ∞R</button>
        <button class="btn-red" onclick="forceReset()">‚ö†Ô∏è Sƒ±fƒ±rla</button>
        <input type="text" id="msg-input" placeholder="Site Mesajƒ± Yaz..." oninput="updateMsg(this.value)">
    </div>
    <div id="controls" style="display:none; gap:5px;">
        <span id="sel-name" style="margin-right:10px; font-weight:bold; font-size:13px; color:#ddd; display:none;"></span>
        
        <button class="btn-cyan" onclick="copyPerson()" id="btn-copy" style="display:none;">üìÑ Kopyala</button>
        <button class="btn-cyan" onclick="pastePerson('child')" id="btn-paste-child" style="display:none;">üìã Yapƒ±≈ütƒ±r (√áocuk)</button>
        <button class="btn-red" onclick="clearClipboard()" id="btn-clear-copy" style="display:none; padding:8px; width:32px;">‚úñ</button>
        
        <button id="btn-delete-tree" class="btn-red" style="display:none;" onclick="deleteCurrentTree()">üóëÔ∏è Aƒüacƒ± Sil</button> 
        <button class="btn-red" onclick="deleteNode()">üóëÔ∏è Ki≈üiyi Sil</button> 
        <button id="btn-tree-action" class="btn-purple" onclick="handleTreeAction()">üå≥ Aƒüa√ß ƒ∞≈ülemi</button>
        <button class="btn-cyan" id="btn-parent" onclick="addParent()" style="display:none;">‚¨ÜÔ∏è Anne/Baba</button>
        <button class="btn-pink" onclick="addSpouse()">‚ù§Ô∏è E≈ü</button>
        <button class="btn-green" onclick="addChild()">‚¨áÔ∏è √áocuk</button>
        <button class="btn-orange" onclick="addSibling()">‚û°Ô∏è Karde≈ü</button>
        <button class="btn-dark" onclick="startMove()" id="btn-move">‚áÑ Deƒüi≈ütir</button>
        <button class="btn-blue" onclick="openEdit()">‚úèÔ∏è D√ºzenle</button>
    </div>
</div>

<div id="site-msg-display"></div>
<button id="msg-reopen-btn" onclick="toggleMsg(true)">üí¨ Mesaj</button>

<div id="viewport"><div id="world"><div class="tree" id="root"></div></div></div>
<div id="bottom-bar"><button class="btn-focus" onclick="centerTree()">üéØ Merkeze D√∂n</button><label id="hand-mode-box"><input type="checkbox" id="hand-mode-toggle" onchange="toggleHandMode()">üñêÔ∏è Gezinme (El Modu)</label><span>üîç</span><input type="range" id="zoom-range" min="0.2" max="2.5" step="0.1" value="1"></div>

<div id="insta-overlay">
    <div id="insta-card">
        <button class="close-insta" onclick="closeInsta()">‚úï</button>
        <div id="insta-img-area">
            <button class="slide-btn prev-btn" onclick="changeSlide(-1)">‚ùÆ</button>
            <img id="insta-img" src="">
            <button class="slide-btn next-btn" onclick="changeSlide(1)">‚ùØ</button>
            <div id="fullscreen-hint">Tam ekran i√ßin √ßift tƒ±klayƒ±n</div>
            <div id="insta-dots" class="slide-dots"></div>
        </div>
        <div id="insta-info"></div>
    </div>
</div>

<div id="modal"><div class="modal-box"><h3>Ki≈üi D√ºzenle</h3>
    <div class="input-row"><label>Ad:</label><input type="text" id="m-name"></div>
    <div class="input-row"><label>Soyad:</label><input type="text" id="m-surname"></div>
    <div class="input-row"><label>Cinsiyet:</label><select id="m-gender"><option value="male">Erkek</option><option value="female">Kadƒ±n</option></select></div>
    
    <div class="input-row" style="background:#f9f9f9; padding:8px; border-radius:8px; border:1px solid #ddd;">
        <label>Baƒülantƒ± Y√∂n√º (Kime Baƒülƒ±?):</label>
        <select id="m-conn-type" style="width:100%; padding:8px;">
            <option value="">Normal (Ortak √áocuk)</option>
            <option value="to-dotted">√úvey (Noktalƒ±)</option>
        </select>
        <div style="font-size:10px; color:#666; margin-top:3px;">E≈ü ise aradaki √ßizgiyi, √ßocuk ise √ºst √ßizgiyi deƒüi≈ütirir.</div>
    </div>

    <div class="input-row" id="stem-slider-wrapper" style="background:#fff3e0; padding:10px; border-radius:8px; border:1px solid #ffcc80; margin-top:10px;">
        <label style="color:#e67e22; font-weight:bold;">üîß Manuel √áizgi Ayarƒ± (Kaydƒ±r):</label>
        <div style="display:flex; align-items:center; gap:10px;">
            <input type="range" id="m-stem-percent" min="0" max="100" value="50" style="flex:1;">
            <span id="m-stem-val" style="font-size:14px; font-weight:bold; width:40px; text-align:center;">%50</span>
        </div>
        <div style="font-size:10px; color:#666; margin-top:5px;">Sola/Saƒüa kaydƒ±rarak √ßizgiyi tam hizala.</div>
    </div>

    <div class="input-row"><label>√únvan:</label><input type="text" id="m-title"></div>
    <div class="input-row"><label>Konum:</label><input type="text" id="m-loc"></div>
    <div class="input-row" style="display:flex; gap:10px;"><div style="flex:1"><label>Doƒüum:</label><input type="text" id="m-birth"></div><div style="flex:1"><label>Vefat:</label><input type="text" id="m-death"></div></div>
    <div class="input-row"><label>Notlar:</label><textarea id="m-note" rows="2"></textarea></div>
    <div class="checkbox-container"><input type="checkbox" id="m-dead"> <label>Vefat (Rahmetli)</label></div>
    
    <div class="input-row" style="margin-top:15px; background:#eef; padding:10px; border-radius:8px; border:1px dashed #99f;">
        <label>Y√∂ntem 1: Dosya Adƒ± (√ñnerilen)</label>
        <input type="text" id="m-photo-path" placeholder="√ñrn: fotograflar/dede.jpg" style="font-size:12px; margin-bottom:5px;">
        <div style="font-size:10px; color:#555;">Klas√∂rdeki dosya adƒ±nƒ± yaz.</div>
    </div>

    <div class="input-row" style="margin-top:5px; background:#eee; padding:10px; border-radius:8px;">
        <label>Y√∂ntem 2: Direkt Y√ºkle</label>
        <input type="file" id="m-photo" accept="image/*" style="display:block; margin-bottom:5px;">
        <div id="photo-gallery" class="photo-gallery"></div>
    </div>
    
    <div style="text-align:right; margin-top:15px;"><button class="btn-red" onclick="closeModal()">ƒ∞ptal</button><button class="btn-green" onclick="saveEdit()">Kaydet</button></div>
</div></div>
<div id="loading-overlay" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; color: white; flex-direction: column; justify-content: center; align-items: center; text-align: center; font-size: 20px;"></div>

<script>
    const INITIAL_DATA = {"trees":{"main":[{"id":1,"name":"BA≈ûLANGI√á","surname":"","gender":"male","title":"K√∂k","loc":"","note":"","birth":"","death":"","photos":[],"isDeceased":false,"spouse":null,"children":[]}]},"rootId":"main", "siteMessage": ""};
    let db = INITIAL_DATA; let openTabs = [{id:'main', name:'Ana Sayfa'}]; let currentTreeId = 'main'; let selId = null, selType = null, isMovingMode = false, movingSourceId = null; let tempPhotos = []; let currentSlide = 0;
    let copiedData = null; // Kopyalanan veriyi tutar
    
    // Aƒüa√ß konumlarƒ±nƒ± hafƒ±zada tutmak i√ßin obje
    let treeViews = {}; // { 'main': {x:0, y:0, s:1}, 'tree_123': {...} }

    const vp = document.getElementById('viewport'); const world = document.getElementById('world'); const zoomRng = document.getElementById('zoom-range'); const handToggle = document.getElementById('hand-mode-toggle');
    let scale = 1, panning = false, pointX = 0, pointY = 0, startX = 0, startY = 0; let initialPinchDistance = 0; let initialScale = 1;

    function setTransform() { world.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`; zoomRng.value = scale; }
    rng=zoomRng; rng.addEventListener('mousedown',(e)=>e.stopPropagation()); rng.addEventListener('touchstart',(e)=>e.stopPropagation()); rng.oninput=(e)=>{scale=parseFloat(e.target.value);setTransform()};

    function centerTree() { const vpW = vp.offsetWidth; const vpH = vp.offsetHeight; let rootCard = document.querySelector("#root > ul > li > .couple-wrapper > .card");
        if (rootCard) { const rect = rootCard.getBoundingClientRect(); const currentCenterX = rect.left + rect.width / 2; const currentCenterY = rect.top + rect.height / 2; const targetX = vpW / 2; const targetY = 150; pointX += (targetX - currentCenterX); pointY += (targetY - rect.top); setTransform(); } 
        else { pointX = (vpW / 2) - 70; pointY = 50; setTransform(); } }
    
    function centerOnNode(id, type) {
        let cardSelector = `.card[onclick*="${id}, '${type}'"]`;
        let cardEl = document.querySelector(cardSelector);
        if (!cardEl) return;
        let rect = cardEl.getBoundingClientRect();
        const vpW = vp.offsetWidth; const vpH = vp.offsetHeight;
        const cardCenterX = rect.left + rect.width / 2; const cardCenterY = rect.top + rect.height / 2;
        const targetX = vpW / 2; const targetY = vpH / 2;
        pointX += (targetX - cardCenterX); pointY += (targetY - cardCenterY);
        setTransform();
    }
    
    function centerAndShowInsta(e, id, type) {
        centerOnNode(id, type);
        setTimeout(() => { showInsta(e, id, type); }, 100); 
    }

    function toggleHandMode() { if(!handToggle.checked) { vp.style.cursor='default'; } else { vp.style.cursor='grab'; } }

    vp.addEventListener('mousedown', (e) => { if(e.target.closest('.card') || e.target.closest('.inspect-btn') || e.target.closest('.portal-indicator') || e.target.closest('.msg-close-btn') || e.target.closest('#insta-card')) return; if(!handToggle.checked) return; panning=true; startX=e.clientX-pointX; startY=e.clientY-pointY; vp.style.cursor='grabbing'; });
    window.addEventListener('mousemove', (e) => { if(panning){ e.preventDefault(); pointX=e.clientX-startX; pointY=e.clientY-startY; setTransform(); } });
    window.addEventListener('mouseup', () => { panning=false; if(handToggle.checked) vp.style.cursor='grab'; else vp.style.cursor='default'; });
    vp.addEventListener('wheel', (e) => { if(!handToggle.checked) return; e.preventDefault(); const delta = -Math.sign(e.deltaY)*0.1; scale=Math.min(Math.max(scale+delta,0.2),2.5); setTransform(); }, {passive:false});
    vp.addEventListener('touchstart', (e) => { if(e.target.closest('.card') || e.target.closest('.inspect-btn') || e.target.closest('.portal-indicator') || e.target.closest('.msg-close-btn') || e.target.closest('#insta-card')) return; if(e.touches.length === 2) { panning = false; initialPinchDistance = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); initialScale = scale; } else if(e.touches.length === 1 && handToggle.checked){ panning=true; startX = e.touches[0].clientX - pointX; startY = e.touches[0].clientY - pointY; } }, {passive: false});
    window.addEventListener('touchmove', (e) => { if (e.touches.length === 2 && initialPinchDistance > 0) { e.preventDefault(); const currentDistance = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); const ratio = currentDistance / initialPinchDistance; scale = Math.min(Math.max(initialScale * ratio, 0.2), 2.5); setTransform(); } else if(panning && e.touches.length === 1){ e.preventDefault(); pointX = e.touches[0].clientX - startX; pointY = e.touches[0].clientY - startY; setTransform(); } }, {passive: false});
    window.addEventListener('touchend', () => { panning=false; initialPinchDistance = 0; });

    window.onload = function() { 
        let s = localStorage.getItem('aile_v110_final'); 
        if(s) { try { db = JSON.parse(s); } catch(e) { db = INITIAL_DATA; } } else { db = INITIAL_DATA; } 
        if(db.siteMessage) { document.getElementById('msg-input').value = db.siteMessage; updateMsg(db.siteMessage); }
        loadTree('main'); setTimeout(() => { centerTree(); }, 250); 
    };

    function updateMsg(val) {
        db.siteMessage = val;
        let d = document.getElementById('site-msg-display');
        d.innerHTML = `<button class="msg-close-btn" onclick="toggleMsg(false)">‚úï</button>` + val;
        d.style.display = val ? 'block' : 'none';
        doFinal();
        toggleMsg(true);
    }

    function toggleMsg(show) {
        const box = document.getElementById('site-msg-display');
        const btn = document.getElementById('msg-reopen-btn');
        if(!db.siteMessage) { box.style.display='none'; btn.style.display='none'; return; }
        if (show) { box.style.display = 'block'; btn.style.display = 'none'; } else { box.style.display = 'none'; btn.style.display = 'block'; }
    }

    // --- AKILLI NAVƒ∞GASYON MANTIƒûI ---
    function loadTree(tid) { 
        // 1. Mevcut aƒüacƒ±n konumunu kaydet
        if (currentTreeId) {
            treeViews[currentTreeId] = { x: pointX, y: pointY, s: scale };
        }

        // 2. Yeni aƒüaca ge√ß
        if (!db.trees[tid]) tid = 'main'; 
        currentTreeId = tid; 
        refresh(); 
        updateTabs(); 

        // 3. Konumu geri y√ºkle veya merkezle
        if (treeViews[tid]) {
            // Daha √∂nce buradaysak, kaldƒ±ƒüƒ±mƒ±z yere git
            pointX = treeViews[tid].x;
            pointY = treeViews[tid].y;
            scale = treeViews[tid].s;
            setTransform();
        } else {
            // ƒ∞lk kez giriyorsak merkeze git
            setTimeout(() => { centerTree(); }, 100); 
        }
    }
    
    function refresh() { 
        let rootNode = db.trees[currentTreeId][0]; 
        document.getElementById('root').innerHTML = "<ul>" + build(rootNode) + "</ul>"; 
        updateTabs(); 
        
        document.getElementById('controls').style.display = selId ? 'flex' : 'none'; 
        let moveBtn = document.getElementById('btn-move'); 
        if(isMovingMode) { moveBtn.style.background='#e67e22'; moveBtn.innerText='ƒ∞PTAL ET'; } else { moveBtn.style.background='#34495e'; moveBtn.innerText='‚áÑ Deƒüi≈ütir'; } 
        
        if(selId) { 
            let p = getType(selId, selType); 
            if(p) { 
                document.getElementById('sel-name').innerText = p.name; 
                document.getElementById('sel-name').style.display='inline'; 
                let treeBtn = document.getElementById('btn-tree-action'); 
                let delTreeBtn = document.getElementById('btn-delete-tree'); 
                if(db.trees['tree_' + p.id]) { treeBtn.innerText = "üå≤ Aƒüacƒ± G√∂r√ºnt√ºle"; treeBtn.className = "btn-green"; treeBtn.style.display = "inline-flex"; delTreeBtn.style.display = 'inline-flex'; } 
                else { treeBtn.innerText = "‚ûïüå≥ Yeni Aƒüa√ß Olu≈ütur"; treeBtn.className = "btn-purple"; treeBtn.style.display = "inline-flex"; delTreeBtn.style.display = 'none'; } 
                
                // Kopyala Butonu
                document.getElementById('btn-copy').style.display = 'inline-flex';

                // Yapƒ±≈ütƒ±r Butonu ve Temizle Butonu
                if(copiedData) {
                    document.getElementById('btn-paste-child').style.display = 'inline-flex';
                    document.getElementById('btn-clear-copy').style.display = 'inline-flex';
                } else {
                    document.getElementById('btn-paste-child').style.display = 'none';
                    document.getElementById('btn-clear-copy').style.display = 'none';
                }
            } 
        } else {
            document.getElementById('btn-copy').style.display = 'none';
            document.getElementById('btn-paste-child').style.display = 'none';
            document.getElementById('btn-clear-copy').style.display = 'none';
        }

        let parentBtn = document.getElementById('btn-parent'); if(selId && selType === 'main' && rootNode && rootNode.id === selId) parentBtn.style.display = 'inline-flex'; else parentBtn.style.display = 'none'; 
    }
    
    function updateTabs() { const c = document.getElementById('tabs-container'); c.innerHTML=''; openTabs.forEach((t,i) => { let d = document.createElement('div'); d.className='tab '+(t.id===currentTreeId?'active':'') + (t.id==='main'?' home':''); let sp = document.createElement('span'); sp.innerText=t.name; sp.onclick=()=>{if(currentTreeId!==t.id){ curId=t.id; selId=null; moveMode=false; loadTree(t.id); }}; d.appendChild(sp); if(t.id!=='main'){ let x = document.createElement('span'); x.className='tab-close'; x.innerText='‚úï'; x.onclick=(e)=>{ e.stopPropagation(); openTabs.splice(i,1); if(t.id===currentTreeId) loadTree(openTabs[i-1] ? openTabs[i-1].id : 'main'); else updateTabs(); }; d.appendChild(x); } c.appendChild(d); }); }
    
    // --- MANUEL VE Dƒ∞NAMƒ∞K √áƒ∞ZGƒ∞ Sƒ∞STEMƒ∞ ---
    function build(n) { 
        if(!n) return ""; 
        let spouseLineClass = ""; if (n.spouse && n.spouse.connType) { spouseLineClass = n.spouse.connType; }
        let childLineClass = n.connType || '';
        
        let axisStyle = "";
        if (n.stemPercent !== undefined && n.stemPercent !== null) {
            axisStyle = `style="--stem-pos: ${n.stemPercent}%;"`;
        }

        let h = `<li class="${childLineClass}" ${axisStyle}><div class="couple-wrapper ${n.spouse?'has-spouse':''} ${spouseLineClass}">${createCard(n,'main')}${n.spouse?createCard(n.spouse,'spouse',n.id):''}</div>`; 
        
        if(n.children && n.children.length>0) { h+=`<ul ${axisStyle}>`; n.children.forEach(c=>h+=build(c)); h+="</ul>"; } 
        return h+"</li>"; 
    }
    
    function createCard(p, type, pid=null) { 
        let id = type==='main'?p.id:pid; let isS = (selId===id && selType===type); let ic = p.gender==='female'?'üë©':'üë®'; let movingClass = (isMovingMode && movingSourceId === p.id && type === 'main') ? 'moving-source' : ''; if(!p.photos) p.photos = p.photo ? [p.photo] : []; let mainPhoto = p.photos.length > 0 ? p.photos[0] : null; let hasTree = db.trees['tree_'+p.id] ? 'has-portal' : ''; 
        return `<div class="card ${p.gender} ${p.isDeceased?'deceased':''} ${isS?'selected':''} ${movingClass} ${hasTree}" onclick="cardClick(event, ${id}, '${type}')"><div class="inspect-btn icon-btn" onclick="centerAndShowInsta(event, ${id}, '${type}')">üëÅÔ∏è</div><div class="ribbon">üéóÔ∏è</div><div class="portal-indicator icon-btn" onclick="enterPortalDirect(event, ${id}, '${type}')"></div><div class="photo" onclick="showInsta(event, ${id}, '${type}')">${mainPhoto?`<img src="${mainPhoto}">`:`<span style="font-size:30px">${ic}</span>`}</div><span class="name">${p.name}</span><span class="surname">${p.surname||''}</span><span class="title">${p.title||''}</span>${p.loc?`<span class="info-row">üìç ${p.loc}</span>`:''}${(p.birth||p.death)?`<span class="info-row">${p.birth||'?'} - ${p.death||'?'}</span>`:''}${p.note?`<div class="note-preview">üìù ${p.note}</div>`:''}</div>`; 
    }
    
    function cardClick(e, id, type) { if(e.target.classList.contains('inspect-btn') || e.target.classList.contains('portal-indicator') || e.target.closest('.photo')) return; e.stopPropagation(); panning = false; if(isMovingMode && type === 'main') performMove(id); else { selId=id; selType=type; refresh(); } }
    function enterPortalDirect(e, id, type) { e.stopPropagation(); let p = getType(id, type); let key = 'tree_' + p.id; if(db.trees[key]) { if(!openTabs.find(x=>x.id===key)) openTabs.push({id:key, name:p.name}); loadTree(key); } else { alert("Bu ki≈üinin bir aƒüacƒ± yok. √ñnce olu≈üturmalƒ±sƒ±n."); } }
    function startMove() { if (!selId || selType !== 'main') { alert("Ana ki≈üiyi se√ß."); return; } let p = find(db.trees[currentTreeId][0], selId); if(p.id === db.trees[currentTreeId][0].id) { alert("K√∂k ta≈üƒ±namaz."); return; } isMovingMode = !isMovingMode; movingSourceId = isMovingMode ? selId : null; refresh(); }
    function performMove(targetId) { if(targetId === movingSourceId) { isMovingMode=false; movingSourceId=null; refresh(); return;} let p1 = findParent(db.trees[currentTreeId][0], movingSourceId); let p2 = findParent(db.trees[currentTreeId][0], targetId); if(!p1 || !p2 || p1.id !== p2.id) { alert("Sadece karde≈üler."); isMovingMode=false; movingSourceId=null; refresh(); return; } let i1 = p1.children.findIndex(c => c.id === movingSourceId); let i2 = p1.children.findIndex(c => c.id === targetId); [p1.children[i1], p1.children[i2]] = [p1.children[i2], p1.children[i1]]; isMovingMode = false; selId = null; movingSourceId=null; doFinal(); }
    function handleTreeAction() { if(!selId) return; let p = getType(selId, selType); let key = 'tree_' + p.id; if(db.trees[key]) { if(!openTabs.find(x=>x.id===key)) openTabs.push({id:key, name:p.name}); loadTree(key); } else { if(confirm(p.name + " i√ßin yeni bir soy aƒüacƒ± olu≈üturulsun mu?")) { db.trees[key] = [{id:Date.now(), name:p.name, surname:p.surname, gender:p.gender, title:"K√∂k", loc:"", note:"", birth:"", death:"", photos:[], isDeceased:false, spouse:null, children:[]}]; if(!openTabs.find(x=>x.id===key)) openTabs.push({id:key, name:p.name}); doFinal(); loadTree(key); } } }
    function deleteCurrentTree() { if(!selId) return; let p = getType(selId, selType); let key = 'tree_' + p.id; if(!db.trees[key]) return; let treeRoot = db.trees[key][0]; let isFull = (treeRoot.children && treeRoot.children.length > 0) || (treeRoot.spouse); if(isFull) { if(!confirm("Bu aƒüa√ß dolu. Silmek istediƒüine emin misin?")) return; } delete db.trees[key]; let tabIndex = openTabs.findIndex(t => t.id === key); if(tabIndex !== -1) openTabs.splice(tabIndex, 1); if(currentTreeId === key) loadTree('main'); else { doFinal(); refresh(); } }
    function deleteNode(){ if(!selId) { alert("Kimse se√ßili deƒüil!"); return; } if(confirm("Bu ki≈üiyi silmek istediƒüine emin misin?")){ if(selType==='spouse') { let p = getP(selId, 'main'); if(p) p.spouse = null; } else { let treeRoot = db.trees[currentTreeId][0]; if(selId == treeRoot.id) { alert("K√∂k ki≈üi (Ba≈ülangƒ±√ß) silinemez!"); return; } let par = findParent(treeRoot, selId); if(par) { par.children = par.children.filter(x => x.id != selId); } else { alert("Hata: Ki≈üi bulunamadƒ±."); return; } } selId=null; doFinal(); } }
    
    // --- KOPYALA / YAPI≈ûTIR MANTIƒûI ---
    function copyPerson() {
        if (!selId) return;
        let p = getType(selId, selType);
        // Yeni bir kopya olu≈ütur
        copiedData = { ...p, id: null, children: [], spouse: null, connType: "", stemPercent: 50 };
        alert(p.name + " kopyalandƒ±! Ba≈üka bir aƒüaca gidip yapƒ±≈ütƒ±rabilirsin.");
        refresh(); // Butonlarƒ± g√ºncelle
    }

    function pastePerson(asType) {
        if (!selId || !copiedData) return;
        let newPerson = { ...copiedData, id: Date.now() };

        if (asType === 'child') {
            let p = getP(selId, 'main');
            p.children.push(newPerson);
            alert(newPerson.name + " √ßocuk olarak eklendi!");
            copiedData = null; // Yapƒ±≈ütƒ±rdƒ±ktan sonra temizle
        } 
        doFinal();
    }

    function clearClipboard() {
        copiedData = null;
        refresh(); // Butonlarƒ± gizle
    }

    // --- FOTOƒûRAF G√ñR√úNT√úLEYƒ∞Cƒ∞ ---
    let touchStartDist = 0, currentImgScale = 1, imgStartScale = 1;
    let imgTouchStartX = 0, imgTouchStartY = 0;
    let imgTranslateX = 0, imgTranslateY = 0;
    let lastTapTime = 0;

    const imgArea = document.getElementById('insta-img-area');
    const imgEl = document.getElementById('insta-img');
    const cardEl = document.getElementById('insta-card');

    function toggleFullScreenMode() { cardEl.classList.toggle('is-fullscreen'); }

    imgArea.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
            touchStartDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            imgStartScale = currentImgScale;
        } else if (e.touches.length === 1) {
            imgTouchStartX = e.touches[0].pageX - imgTranslateX;
            imgTouchStartY = e.touches[0].pageY - imgTranslateY;
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTapTime;
            if (tapLength < 300 && tapLength > 0) { toggleFullScreenMode(); e.preventDefault(); }
            lastTapTime = currentTime;
        }
    });

    imgArea.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) { e.preventDefault(); const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); if (touchStartDist > 0) { const newScale = imgStartScale * (dist / touchStartDist); currentImgScale = Math.min(Math.max(newScale, 1), 4); updateImgTransform(); }
        } else if (e.touches.length === 1 && currentImgScale > 1) { e.preventDefault(); imgTranslateX = e.touches[0].pageX - imgTouchStartX; imgTranslateY = e.touches[0].pageY - imgTouchStartY; updateImgTransform(); }
    });

    function updateImgTransform() { imgEl.style.transform = `translate(${imgTranslateX}px, ${imgTranslateY}px) scale(${currentImgScale})`; }
    function resetZoom() { currentImgScale = 1; imgTranslateX = 0; imgTranslateY = 0; updateImgTransform(); }

    function showInsta(e, id, type) { e.stopPropagation(); let p = getType(id, type); activePersonPhotos = p.photos && p.photos.length > 0 ? p.photos : []; currentSlide = 0; resetZoom(); cardEl.classList.remove('is-fullscreen'); updateSlideShow(); let html = `<h1 style="margin:0">${p.name} ${p.surname||''}</h1>`; if(p.title) html += infoBox("√úNVAN", p.title); if(p.loc) html += infoBox("KONUM", p.loc); if(p.birth||p.death) html += infoBox("TARƒ∞H", (p.birth||'?') + " - " + (p.death||'?')); if(p.note) html += infoBox("NOTLAR", p.note); document.getElementById('insta-info').innerHTML = html; document.getElementById('insta-overlay').style.display='flex'; }
    function closeInsta() { document.getElementById('insta-overlay').style.display='none'; }
    function updateSlideShow() { let img = document.getElementById('insta-img'); let dots = document.getElementById('insta-dots'); dots.innerHTML = ""; resetZoom(); if (activePersonPhotos.length === 0) { img.style.display = 'none'; } else { img.style.display = 'block'; img.src = activePersonPhotos[currentSlide]; activePersonPhotos.forEach((_, idx) => { let d = document.createElement('div'); d.className = 'dot ' + (idx === currentSlide ? 'active' : ''); dots.appendChild(d); }); } document.querySelector('.prev-btn').style.display = activePersonPhotos.length > 1 ? 'flex' : 'none'; document.querySelector('.next-btn').style.display = activePersonPhotos.length > 1 ? 'flex' : 'none'; }
    function changeSlide(dir) { if (activePersonPhotos.length <= 1) return; currentSlide += dir; if (currentSlide < 0) currentSlide = activePersonPhotos.length - 1; if (currentSlide >= activePersonPhotos.length) currentSlide = 0; updateSlideShow(); }
    function infoBox(l,v){ return `<div class="info-block"><div class="info-label">${l}</div><div class="info-val">${v}</div></div>`; }
    function addParent() { if(!selId || selType !== 'main') return; let currentRoot = db.trees[currentTreeId][0]; if(currentRoot.id !== selId) return; let newRoot = { id: Date.now(), name: "Yeni", surname: "Anne/Baba", gender: "male", title: "K√∂k", loc: "", note: "", birth: "", death: "", photos: [], isDeceased: false, spouse: null, children: [currentRoot] }; db.trees[currentTreeId][0] = newRoot; currentRoot.title = ""; selId = newRoot.id; doFinal(); }
    
    function openEdit() { 
        if(!selId) return; 
        let p=getType(selId,selType); 
        document.getElementById('m-name').value=p.name; document.getElementById('m-surname').value=p.surname||""; document.getElementById('m-gender').value=p.gender||"male"; document.getElementById('m-title').value=p.title||""; document.getElementById('m-loc').value=p.loc||""; document.getElementById('m-note').value=p.note||""; document.getElementById('m-birth').value=p.birth||""; document.getElementById('m-death').value=p.death||""; document.getElementById('m-dead').checked=p.isDeceased||false; 
        
        document.getElementById('m-conn-type').value = p.connType || "";

        document.getElementById('stem-slider-wrapper').style.display = 'block';
        let val = (p.stemPercent !== undefined && p.stemPercent !== null) ? p.stemPercent : 50;
        document.getElementById('m-stem-percent').value = val;
        document.getElementById('m-stem-val').innerText = "%" + val;

        let pathPhoto = "";
        if(p.photos && p.photos.length > 0) { if(!p.photos[0].startsWith("data:image")) { pathPhoto = p.photos[0]; } }
        document.getElementById('m-photo-path').value = pathPhoto;
        tempPhotos = p.photos ? [...p.photos] : (p.photo ? [p.photo] : []); 
        renderPhotoGallery(); 
        document.getElementById('modal').style.display='flex'; 
    }
    
    document.getElementById('m-stem-percent').addEventListener('input', function(e) {
        document.getElementById('m-stem-val').innerText = "%" + e.target.value;
    });

    function renderPhotoGallery() { let c = document.getElementById('photo-gallery'); c.innerHTML = ""; tempPhotos.forEach((src, idx) => { let div = document.createElement('div'); div.className = 'mini-photo-wrapper'; div.innerHTML = `<img src="${src}" class="mini-photo"><div class="delete-mini" onclick="deleteMiniPhoto(${idx})">√ó</div>`; c.appendChild(div); }); document.getElementById('m-photo').style.display = tempPhotos.length >= 4 ? 'none' : 'block'; }
    document.getElementById('m-photo').addEventListener('change', function(e) { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = function(event) { if (tempPhotos.length < 4) { tempPhotos.push(event.target.result); renderPhotoGallery(); } else { alert("En fazla 4 fotoƒüraf."); } }; reader.readAsDataURL(file); } });
    function deleteMiniPhoto(idx) { tempPhotos.splice(idx, 1); renderPhotoGallery(); }
    
    function saveEdit() { 
        let p = getType(selId,selType); 
        p.name=document.getElementById('m-name').value; p.surname=document.getElementById('m-surname').value; p.gender=document.getElementById('m-gender').value; p.title=document.getElementById('m-title').value; p.loc=document.getElementById('m-loc').value; p.note=document.getElementById('m-note').value; p.birth=document.getElementById('m-birth').value; p.death=document.getElementById('m-death').value; p.isDeceased=document.getElementById('m-dead').checked; 
        
        p.connType = document.getElementById('m-conn-type').value;
        p.stemPercent = document.getElementById('m-stem-percent').value;

        let pathVal = document.getElementById('m-photo-path').value.trim();
        let finalPhotos = [...tempPhotos];
        if (pathVal && !finalPhotos.includes(pathVal)) { finalPhotos.push(pathVal); }
        p.photos = finalPhotos; delete p.photo; 
        doFinal(); 
        document.getElementById('modal').style.display='none'; 
    }
    
    function doFinal(){ try { localStorage.setItem('aile_v110_final', JSON.stringify(db)); } catch(e) { console.log("Hafƒ±za limiti, RAM kullanƒ±lƒ±yor."); } refresh(); }
    function closeModal() { document.getElementById('modal').style.display='none'; }
    function addSpouse(){ let p=getP(selId,'main'); if(p.spouse && !confirm("E≈ü deƒüi≈üsin mi?")) return; p.spouse={id:Date.now(), name:"E≈ü", surname:"", gender:p.gender==='male'?'female':'male', photos:[]}; doFinal(); }
    function addChild(){ let p=getP(selId,'main'); p.children.push({id:Date.now(), name:"√áocuk", surname:"", gender:"male", photos:[], children:[]}); doFinal(); }
    function addSibling(){ let par=getParent(db.trees[currentTreeId][0], selId); if(!par) return; par.children.push({id:Date.now(), name:"Karde≈ü", surname:"", gender:"male", photos:[], children:[]}); doFinal(); }
    function findParent(node, id) { if (!node || !node.children) return null; for (let child of node.children) { if (child.id == id) return node; let found = findParent(child, id); if (found) return found; } return null; }
    function getParent(root, id) { return findParent(root, id); }
    function getP(id, t) { let n=find(db.trees[currentTreeId][0], id); return t==='main'?n:n.spouse; }
    function find(n, id) { if(n.id===id) return n; for(let c of n.children) { let f=find(c,id); if(f) return f; } return null; }
    function getType(id,type) { let n=find(db.trees[currentTreeId][0],id); return type==='main'?n:n.spouse; }
    function downloadData() { let a=document.createElement('a'); a.href='data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(db)); a.download='aile_yedek.json'; a.click(); }
    function uploadData(inp) { let r=new FileReader(); r.onload=e=>{try{let loaded = JSON.parse(e.target.result); if(loaded.trees) { db = loaded; 
        if(db.siteMessage) { document.getElementById('msg-input').value = db.siteMessage; updateMsg(db.siteMessage); } else { updateMsg(""); document.getElementById('msg-input').value = ""; }
        openTabs=[{id:'main',name:'Ana Sayfa'}]; loadTree('main'); centerTree(); alert("Y√ºklendi!"); } }catch(x){alert("Hata!");}}; r.readAsText(inp.files[0]); }
    function toggleDeadCheckbox() { let c=document.getElementById('m-dead'); c.checked=!c.checked; }
    function forceReset() { if(confirm("Her ≈üey silinecek?")) { localStorage.removeItem('aile_v110_final'); location.reload(); } }
    
    function generateShareFile() {
        document.getElementById('loading-overlay').style.display = 'flex';
        document.getElementById('loading-overlay').innerHTML = '<div style="font-size:40px;">üíæ</div><div style="margin-top:20px;">Site Olu≈üturuluyor...</div>';
        
        setTimeout(() => {
            const base64Data = btoa(unescape(encodeURIComponent(JSON.stringify(db))));
            let scriptContent = document.querySelector('script').innerHTML;
            scriptContent = scriptContent.replace('const INITIAL_DATA', `const INITIAL_DATA`).replace(/localStorage\.setItem\(.*?\);/g, '').replace(/window\.onload\s*=\s*function\(\)\s*\{[\s\S]*?\};/, `window.onload = function() { try { let raw = "${base64Data}"; db = JSON.parse(decodeURIComponent(escape(atob(raw)))); } catch(e) { db = INITIAL_DATA; } if(db.siteMessage){ let box=document.getElementById('site-msg-display'); box.innerHTML='<button class="msg-close-btn" onclick="toggleMsg(false)">‚úï</button>'+db.siteMessage; box.style.display='block'; } setTimeout(function(){ loadTree('main'); centerTree(); }, 100); };`);
            const template = `<!DOCTYPE html><html lang="tr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Aile Aƒüacƒ±</title><style>${document.querySelector('style').innerHTML} #toolbar, #modal, #loading-overlay {display:none !important} #site-msg-display { display: ${db.siteMessage ? 'block' : 'none'}; } #msg-reopen-btn { display: none; }</style></head><body><div id="tabs-container"></div><div id="site-msg-display"></div><button id="msg-reopen-btn" onclick="toggleMsg(true)">üí¨ Mesaj</button><div id="viewport"><div id="world"><div id="root" class="tree"></div></div></div><div id="bottom-bar"><button class="btn-focus" onclick="centerTree()">üéØ Merkeze D√∂n</button><label id="hand-mode-box"><input type="checkbox" id="hand-mode-toggle" onchange="toggleHandMode()">üñêÔ∏è Gezinme (El Modu)</label><span>üîç</span><input type="range" id="zoom-range" min="0.2" max="2.5" step="0.1" value="1"></div><div id="insta-overlay"><div id="insta-card"><button class="close-insta" onclick="closeInsta()">‚úï</button><div id="insta-img-area"><button class="slide-btn prev-btn" onclick="changeSlide(-1)">‚ùÆ</button><img id="insta-img" src=""><button class="slide-btn next-btn" onclick="changeSlide(1)">‚ùØ</button><div id="fullscreen-hint">Tam ekran i√ßin √ßift tƒ±klayƒ±n</div><div id="insta-dots" class="slide-dots"></div></div><div id="insta-info"></div></div></div><script>${scriptContent}<\/script></body></html>`;
            const blob = new Blob([template], {type: 'text/html'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'index.html'; document.body.appendChild(a); a.click(); document.body.removeChild(a); document.getElementById('loading-overlay').style.display = 'none';
        }, 2000);
    }
</script>
</body>
</html>